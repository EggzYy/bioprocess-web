# Metric Extraction Specification

## Overview
This document defines the strict policy for extracting metrics from Excel workbooks generated by the bioprocess optimization system. The key constraint is to **NEVER** use Executive Summary or Financial Metrics sheets.

## Prohibited Sheets
The following sheets **MUST NOT** be used for any metric extraction:
- Executive Summary
- Financial Metrics

## Metric Sources and Fallback Rules

### 1. IRR and NPV
**Primary Source:** Pareto Frontier (first row)
- Sheet: `Pareto Frontier`
- Columns: `irr`, `npv`
- Method: Read first data row (excluding headers)

**Fallback Source:** All Feasible Configurations (first row)
- Sheet: `All Feasible Configurations`
- Columns: `irr`, `npv`
- Method: Read first data row if Pareto Frontier is missing or empty

**Error Handling:** Return NaN with reason if both sources are unavailable

### 2. CAPEX (Total Capital Expenditure)
**Primary Source:** CAPEX Summary
- Sheet: `CAPEX Summary`
- Row Identifier: Where `CAPEX Component` == "Total Initial Investment"
- Column: `Amount (USD)` or `Total Cost (USD)`

**Fallback Source:** Detailed CAPEX Breakdown
- Sheet: `Detailed CAPEX Breakdown`
- Row Identifier: Where `Category` == "TOTAL" AND `Item` == "Total Initial Investment"
- Column: `Total Cost (USD)`

**Error Handling:** Return NaN with specific sheet/column missing information

### 3. OPEX (Operating Expenditure)
**Source:** OPEX Summary
- Sheet: `OPEX Summary`
- Row Identifier: Where `OPEX Component` == "Total Cash OPEX"
- Column: `Annual Cost (USD)`

**Note:** OPEX may not be directly comparable from original Excel to new implementation

### 4. Production and Batch Counts
**Source:** Calc-PerStrain (aggregated across all strain rows)
- Sheet: `Calc-PerStrain`

**Production (kg/year):**
- Primary: Sum of `annual_kg_good` column across all strains
- Fallback: Sum of (`batch_mass_kg` × `good_batches`) across all strains

**Batch Counts:**
- Sum of `good_batches` column across all strains

**Important:** Values are spread across multiple rows (one per strain)

### 5. Equipment Configuration
**Source:** Pareto Frontier (first row)
- Sheet: `Pareto Frontier`
- Columns: 
  - `reactors` (number of fermenters)
  - `ds_lines` (number of downstream lines)
  - `fermenter_volume_L` (fermenter volume in liters)

**Fallback:** All Feasible Configurations (first row) if Pareto Frontier unavailable

### 6. Strain List
**Primary Source:** Calc-PerStrain
- Sheet: `Calc-PerStrain`
- Column: `name` or first column if unnamed

**Fallback Source:** Strain Parameters
- Sheet: `Strain Parameters`
- Column: `Strain` or first column

### 7. Target TPA (Tons Per Annum)
**Source:** Filename parsing
- Pattern: `r"(\d+)\s*TPA"` in filename
- Example: "Facility1_Yogurt_Cultures_10TPA_calc.xlsx" → 10 TPA

## Column Name Normalization
Due to potential variations in column naming, the parser should:
1. Strip leading/trailing whitespace
2. Handle case-insensitive matching
3. Support common variations:
   - `irr` / `IRR` / `IRR (%)`
   - `npv` / `NPV` / `NPV ($)` / `NPV (USD)`
   - `good_batches` / `Good Batches` / `Batches (Good)`
   - `batch_mass_kg` / `Batch Mass (kg)` / `Mass per Batch (kg)`
   - `annual_kg_good` / `Annual Production (kg)` / `Annual kg (Good)`

## Numeric Coercion Rules
1. Remove currency symbols ($, USD)
2. Remove percentage symbols (%)
3. Remove thousands separators (,)
4. Handle parentheses for negative values
5. Convert scientific notation
6. Return NaN for non-numeric or missing values

## Working Volume Considerations
- The Excel workbooks already reflect 80% working volume in their calculations
- Parser should NOT apply any additional scaling
- Values should be read as-is from the sheets

## Error Reporting
When a metric cannot be extracted, the parser should provide:
1. Specific sheet name that was missing or empty
2. Specific column name that was not found
3. Whether it was a primary or fallback source
4. Suggested troubleshooting steps

## Validation Checks
Before accepting extracted metrics:
1. Verify positive values where expected (production, batches, CAPEX)
2. Check IRR is between -100% and reasonable upper bound (e.g., 200%)
3. Verify NPV is finite
4. Ensure production > 0 if batches > 0
5. Check fermenter_volume_L is reasonable (100-10000 L typical range)

## Usage Notes
1. This policy is enforced to ensure consistency and avoid dependency on summary sheets
2. The extraction should be deterministic and reproducible
3. All sources are clearly traceable for audit purposes
4. Missing metrics should not stop the entire parsing process
